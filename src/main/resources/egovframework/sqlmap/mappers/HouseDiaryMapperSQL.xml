<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kt.smartfarm.supervisor.mapper.HouseDiaryMapper">

	<insert id="insertHouseDiary" useGeneratedKeys="true" parameterType="houseDiaryVO">
		INSERT INTO house_diary
			(
				green_house_id,title,content,work,etc,start_date,end_date,crops,harvest,income,spend,content_type,work_time,cctv_image_url,weather
			)
		VALUES 
			(
				#{greenHouseId},#{title},#{content},#{work},#{etc},#{startDate},#{endDate},#{crops},#{harvest},#{income},#{spend},#{contentType},#{workTime},#{cctvImageUrl},#{weather}
			);
		<selectKey keyProperty="id" resultType="int">
		SELECT LAST_INSERT_ID() AS id;
		</selectKey>
	</insert>
	<insert id="insertHouseDiaryFile" parameterType="houseDiaryVO">
		INSERT INTO house_diary_file(
			house_diary_idx,file_name,file,update_date
		)
		VALUES(
			#{id},#{fileName},#{file},NOW()
		)
	</insert>


	<select id="selectHouseDiaryFile" resultType="houseDiaryVO">
		SELECT house_diary_idx, file_name, update_date
		FROM house_diary_file
		WHERE house_diary_idx = #{id} AND file_name = #{fileName};
	</select>


	<insert id="insertCropsDiaryFile" parameterType="cropsDiaryVO">
		INSERT INTO crops_diary_file(
			crops_diary_idx,file_name,file,update_date
		)
		VALUES(
			#{id},#{fileName},#{file},NOW()
		)
	</insert>
	<update id="updateHouseDiary" parameterType="houseDiaryVO">
		UPDATE house_diary
		<set>
			<if test="title != null">title =#{title},</if>
			<if test="content != null">content =#{content},</if>
			<if test="work != null">work =#{work},</if>
			<if test="etc != null">etc =#{etc},</if>
			<if test="startDate != null">start_date =#{startDate},</if>
			<if test="endDate != null">end_date =#{endDate},</if>
			<if test="crops != null">crops =#{crops},</if>
			<if test="harvest != null">harvest =#{harvest},</if>			
			<if test="contentType != null">content_type=#{contentType},</if>
			<if test="workTime != null">work_time =#{workTime},</if>
			income =#{income},
			spend =#{spend}
		</set>
		WHERE id=#{id} AND green_house_id = #{greenHouseId}
	</update>


	<select id="selectCropsDiaryFile" resultType="cropsDiaryVO">
		SELECT crops_diary_idx, file_name, update_date
		FROM crops_diary_file
		WHERE crops_diary_idx = #{id} AND file_name = #{fileName};
	</select>

	<update id="updateHouseDiaryFile" parameterType="houseDiaryVO">
		UPDATE house_diary_file
		SET
			file_name = #{fileName},
			file = #{file},
			update_date = NOW()
		WHERE house_diary_idx=#{id}
	</update>

	<update id="updateCropsDiaryFile" parameterType="cropsDiaryVO">
		UPDATE crops_diary_file
		SET
			file_name = #{fileName},
			file = #{file},
			update_date = NOW()
		WHERE crops_diary_idx=#{id}
	</update>

	<!-- 
	<select id="getHouseDiaryDetail" parameterType="map" resultType="map">
		SELECT 
			id,
			green_house_id,
			title,
			content,
			work,
			etc,
			start_date,
			end_date,
			crops,
			harvest,
			income,
			spend,
			content_type,
			work_time,
			cctv_image_url,
			weather
		FROM house_diary
		WHERE id = #{id}
	</select>
	 -->
	
	<select id="getHouseDiaryDetail" parameterType="map" resultType="map">
		SELECT 
			hd.id,
			hd.green_house_id,
			hd.title,
			hd.content,
			hd.work,
			hd.etc,
			hd.start_date,
			hd.end_date,
			hd.crops,
			hd.harvest,
			hd.income,
			hd.spend,
			hd.content_type,
			hd.work_time,
			hd.cctv_image_url,
			hd.weather			
		FROM house_diary as hd		
		WHERE hd.id = #{id}					
	</select>
	
	<select id="getHouseDiaryFile" parameterType="map" resultType="map">
		SELECT
			file_name,
			file,
			update_date
		FROM house_diary_file		
		WHERE house_diary_idx = #{id}					
	</select>

	<select id="getCropsDiaryFile" parameterType="map" resultType="map">
		SELECT
			file_name,
			file,
			update_date
		FROM crops_diary_file
		WHERE crops_diary_idx = #{id}
	</select>
	
	<select id="getCropsDiaryDetail" parameterType="map" resultType="map">
		SELECT 
			cd.id, 
			cd.green_house_id, 
			cd.leaf_width, 
			cd.stem, 
			cd.harvest, 
			cd.fruit_set, 
			cd.gether_set, 
			cd.fruit_height, 
			cd.bloom, 
			cd.fruit_number, 
			cd.aver_weight, 
			cd.grow_length, 
			cd.leaf_size, 
			cd.leaf_num, 
			cd.start_date, 
			cd.upload_file, 
			cd.content, 
			cd.title, 
			cd.crops,
			cd.content_type,
			cd.cctv_image_url,
			cd.weather			
		FROM crops_diary as cd
		<!-- LEFT OUTER JOIN crops_diary_file AS cdf ON cdf.crops_diary_idx = cd.id -->
		WHERE cd.id = #{id}

	</select>
		

	<!-- 
	<select id="getMonthlyHouseDiaryList" parameterType="map" resultType="houseDiaryVO">
		SELECT 
			hd.id,
			hd.green_house_id,
			hd.title,
			hd.content,
			hd.WORK,
			hd.etc,
			hd.start_date,
			hd.end_date,
			hd.crops,
			hd.harvest,
			hd.income,
			hd.spend,
			hd.content_type,
			hd.work_time,
			hd.cctv_image_url,
			hd.weather,
			hdf.file_name,
			hdf.file,
			hdf.update_date
		FROM house_diary as hd
		LEFT OUTER JOIN house_diary_file AS hdf ON hdf.house_diary_idx = hd.id
		WHERE green_house_id = #{green_house_id}
			<if test="start_date!=null and end_date!=null">AND start_date BETWEEN #{start_date} AND #{end_date}</if> 
			<if test="start_date!=null and end_date!=null">AND end_date BETWEEN #{start_date} AND #{end_date}</if>			
	</select> -->
	
	<select id="getMonthlyHouseDiaryList" parameterType="map" resultType="map">
		SELECT 
			hd.id,
			hd.green_house_id,
			hd.title,			
			hd.start_date,
			hd.end_date,			
			hd.content_type,
			hd.content
		FROM house_diary as hd		
		WHERE green_house_id = #{green_house_id}
			<if test="start_date!=null and end_date!=null">AND start_date BETWEEN #{start_date} AND #{end_date}</if> 
			<if test="start_date!=null and end_date!=null">AND end_date BETWEEN #{start_date} AND #{end_date}</if>			
	</select>
	
	
	<delete id="deleteHouseDiary" parameterType="map">
		DELETE
		FROM house_diary
		WHERE id = #{id};
	</delete>
	<delete id="deleteHouseDiaryFile" parameterType="map">
		DELETE
		FROM house_diary_file
		WHERE house_diary_idx = #{id};
	</delete>
		
	
	
	<insert id="insertCropsDiary" useGeneratedKeys="true" parameterType="cropsDiaryVO">
		INSERT INTO crops_diary(
				green_house_id, leaf_width, stem, harvest, fruit_set, gether_set, fruit_height, bloom, fruit_number, aver_weight, grow_length, leaf_size, leaf_num, start_date, upload_file, content, title, crops, content_type,cctv_image_url,weather
			)
		VALUES(
			#{greenHouseId},#{leafWidth},#{stem},#{harvest},#{fruitSet},#{getherSet},#{fruitHeight},#{bloom},#{fruitNumber},#{averWeight},#{growLength},#{leafSize},#{leafNum},#{startDate},#{uploadFile},#{content},#{title},#{crops}, #{contentType}, #{cctvImageUrl},#{weather}
		)
		<selectKey keyProperty="id" resultType="int">
		SELECT LAST_INSERT_ID() AS id;
		</selectKey>
	</insert>

	<update id="updateCropsDiary" parameterType="cropsDiaryVO">
		UPDATE
		crops_diary
		<set>
		<if test="leafWidth != null">leaf_width = #{leafWidth},</if>
		<if test="stem != null">stem = #{stem},</if>
		<if test="harvest != null">harvest = #{harvest},</if>
		<if test="fruitSet != null">fruit_set = #{fruitSet},</if>
		<if test="getherSet != null">gether_set = #{getherSet},</if>
		<if test="fruitHeight != null">fruit_height = #{fruitHeight},</if>
		<if test="bloom != null">bloom = #{bloom},</if>
		<if test="fruitNumber != null">fruit_number = #{fruitNumber},</if>
		<if test="averWeight != null">aver_weight = #{averWeight},</if>
		<if test="growLength != null">grow_length = #{growLength},</if>
		<if test="leafSize != null">leaf_size = #{leafSize},</if>
		<if test="leafNum != null">leaf_num = #{leafNum},</if>
		<if test="startDate != null">start_date = #{startDate},</if>
		<if test="uploadFile != null">upload_file = #{uploadFile},</if>
		<if test="content != null">content = #{content},</if>
		<if test="title != null">title = #{title},</if>
		<if test="crops != null">crops = #{crops},</if>
		<if test="contentType != null">content_type = #{contentType}</if>
		</set>
		WHERE id = #{id} AND green_house_id = #{greenHouseId};
	</update>
	
	<delete id="deleteCropsDiary" parameterType="map">
		DELETE
		FROM crops_diary
		WHERE id = #{id};
	</delete>
	
	<delete id="deleteCropsDiaryFile" parameterType="map">
		DELETE
		FROM crops_diary_file
		WHERE crops_diary_idx = #{id};
	</delete>
	
	<!-- <select id="getMonthlyCropsDiaryList" parameterType="map" resultType="map">
		SELECT 
			cd.id, 
			cd.green_house_id, 
			cd.leaf_width, 
			cd.stem, 
			cd.harvest, 
			cd.fruit_set, 
			cd.gether_set, 
			cd.fruit_height, 
			cd.bloom, 
			cd.fruit_number, 
			cd.aver_weight, 
			cd.grow_length, 
			cd.leaf_size, 
			cd.leaf_num, 
			cd.start_date, 
			cd.upload_file, 
			cd.content, 
			cd.title, 
			cd.crops,
			cd.content_type,
			cd.cctv_image_url,
			cd.weather_json,
			cdf.file_name,
			cdf.file,
			cdf.update_date			
		FROM crops_diary as cd
		LEFT OUTER JOIN crops_diary_file AS cdf ON cdf.crops_diary_idx = cd.id
		WHERE green_house_id = #{house_id}
		<if test="start_date!=null and end_date!=null">
			AND start_date BETWEEN #{start_date} AND #{end_date}
		</if>
	</select> -->
	<select id="getMonthlyCropsDiaryList" parameterType="map" resultType="map">
		SELECT 
			cd.id, 
			cd.title,
			cd.green_house_id, 
			cd.start_date, 
			cd.content_type,						
			cd.content
		FROM crops_diary as cd		
		WHERE green_house_id = #{green_house_id}
		<if test="start_date!=null and end_date!=null">
			AND start_date BETWEEN #{start_date} AND #{end_date}
		</if>
	</select>
		
	<select id="getCategoryList22" resultType="map">
		SELECT 
			id,category_type,category_name
		FROM cd_diary_category_info
		ORDER BY id;
	</select>
	
	<select id="getHouseCropsInfo" resultType="map" parameterType="map">
		SELECT cp.product_species FROM green_house
		INNER JOIN cd_product_method cpm ON cpm.id = green_house.product_method_id
		INNER JOIN cd_product cp ON cp.id = cpm.product_id
		WHERE green_house.id = #{green_house_id} 
	</select>
	
	<select id="getImageDiaryList" parameterType="map" resultType="map">
		SELECT id,push_date,push_type,push_title,push_message,image_url,weather
		FROM push_history
		WHERE green_house_id = #{houseId}
		AND push_type = 9 
		AND error_message IS NULL
		AND image_url IS NOT NULL
		<!-- push_type이 9인경우는 cctv daily 인 case -->
	</select>
	
</mapper>

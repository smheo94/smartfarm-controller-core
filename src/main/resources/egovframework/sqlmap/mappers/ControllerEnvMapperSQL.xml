<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kt.smartfarm.supervisor.mapper.ControllerEnvMapper">
	
	
	<resultMap id="controllerEnv"
		type="egovframework.customize.service.ControllerEnvVO">
		<result property="id" column="id" javaType="Integer"/>
		<collection property="deviceList" javaType="java.util.ArrayList" ofType="deviceEnvVO" column="controller_id" select="getDeviceList"/>
		<!-- <association property="controllerInfo" column="controllerInfoId" 
		select="egovframework.customize.service.ControllerInfoMapper.select"></association>
		-->
	</resultMap>

	<insert id="insert" useGeneratedKeys="true" parameterType="controllerEnvVO">
		INSERT INTO controller
		(gsm_key, controller_info_id, controller_type, ip, PORT, controller_status,
		description,id
		)
		VALUES (#{gsmKey}, #{controllerInfoId}, #{controllerType}, #{ip},
		#{port}, #{controllerStatus}, #{description}
		<if test="id == null">
			,NEXTVAL(gsm_seq_${gsmKey})
		</if>
		<if test="id != null">
			,#{id}
		</if>
		);
		<selectKey keyProperty="id" resultType="int">
		SELECT LAST_INSERT_ID() AS id;
		</selectKey>
	</insert>
	
	<update id="update" parameterType="controllerEnvVO">
		UPDATE controller
		SET
		<if test="controllerInfoId != null">controller_info_id = #{controllerInfoId}</if>		
		<if test="controllerType != null">,controller_type = #{controllerType}</if>		
		<if test="ip != null">,ip = #{ip}</if>		
		<if test="port != null">,PORT = #{port}</if>		
		<if test="controllerStatus != null">,controller_status = #{controllerStatus}</if>		
		<if test="description != null">,description = #{description}</if>
		WHERE gsm_key = #{gsmKey} AND id = #{id};
	</update>
	<delete id="delete">
		DELETE
		FROM controller
		WHERE gsm_key = #{gsmKey} AND id = #{id};
	</delete>
	
	<select id="list" resultMap="controllerEnv" parameterType="map">
		SELECT id, gsm_key, controller_info_id, controller_type, ip, port,
		controller_status, description
		FROM controller
		<where>
			AND gsm_key = #{gsm_key}
			<if test="id != null"> AND id = #{id}</if>
		</where>
		;
	</select>
	
	<select id="listType" resultType="map">
		SELECT 
			id,
			model,
			name,
			homepage,
			email,
			phone,
			last_update,
			name_i18n
		FROM
			cd_controller_info
	</select>
	
	<select id="get" resultMap="controllerEnv">
		SELECT 
			controller.*,
			device.*
		FROM controller
		INNER JOIN device
		ON device.controller_id = controller.id
		<where>
			AND controller.gsm_key = #{gsm_key}
			<if test="id != null"> AND controller.id = #{id}</if>
		</where>	
	</select>
	
	<select id="getDeviceList" parameterType="Integer" resultType="deviceEnvVO">
		SELECT
			id,
			device_type_id,
			device_type_idx,
			user_info_id,
			gsm_key,
			green_house_id,
			controller_id,
			nickname,
			device_type_nickname,
			description,
			setup_date,
			x_position,
			y_position,
			x2_position,
			y2_position,
			memo,
			modbus_address1,
			modbus_address2,
			modbus_address3,
			no_stop_control,
			`mode`,
			update_date,
			auto_manual_mode,
			`status`,
			device_type
		FROM device
		WHERE controller_id = #{controller_id}
	</select>
</mapper>
